<!DOCTYPE html>
<html lang="en">
<head>
  <title>Plength</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='jquery.Jcrop.min.css') }}">
  <script src="{{ url_for('static', filename='jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='jquery.color.js') }}"></script>
  <script src="{{ url_for('static', filename='jquery.Jcrop.min.js') }}"></script>
  <script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
</head>
<body>
  <div class="container">
    <div class="row">
        <div class="col-md-12">
          <h4>Image Upload</h4>
          <hr>
        </div>
      </div>
    <div class="row">
      <div class="col-md-6">
        <input class="btn btn-default" type="file" id="file"/>
      </div>
      <div class="col-md-6">
        <p id="imageStats"></p>
      </div>
    </div>
    <div class="row" style="padding-top: 10px;">
      <div class="col-md-12" id="views"></div>
    </div>
    <div class="row" style="padding-top: 10px;">
      <div class="col-md-2">
        <button onclick="cropImage()">Crop Image</button>
      </div>
      <div class="col-md-9">
        <label>Hue: <input type=range id=rHue max=359 value=0></label>
        <label>Saturation: <input type=range id=rSat value=0></label>
        <label>Lightness: <input type=range id=rL max=200 value=100></label>
      </div>
    </div>
    <div class="row" style="padding-top: 10px;">
      <div class="col-md-3">
        <input type="radio" name="plant" value="Coleoptile" checked>Coleoptile<br>
        <input type="radio" name="plant" value="Seedling">Seedling<br>
      </div>
      <div class="col-md-3">
          <input type="radio" name="calPos" value="left" checked>Left<br>
          <input type="radio" name="calPos" value="right">Right<br>
      </div>
      <div class="col-md-3">
          Known Distance: <input type="number" name="fname"> mm<br>
      </div>
      <div class="col-md-3">
          Min Detection Distance: <input type="number" name="fname"> pixels<br>
      </div>
    </div>
    <div class="row" style="padding-top: 10px;">
      <div class="col-md-1">
          <button onclick="uploadImage()">Upload</button>
      </div>
    </div>
  </div>
  <div id="temp"></div>
</body>
</html> 

<script>
  var crop_max_width = 400;
  var crop_max_height = 400;
  var jcrop_api;
  var canvas;
  var context;
  var image;
  var hue = 200;
  var sat = 0;
  var lightness= 100;

  var prefsize;

  $("#file").change(function() {
    loadImage(this);
  });

  $('input[type=range]').on('input', function () {
    $(this).trigger('change');
  });

  $('#rHue').change( function() { 
    setHue()
  });

  $('#rSat').change( function() { 
    setSaturation();
  });

  $('#rL').change( function() { 
    setLightness();
  });

  function loadImage(input) {
    if (input.files && input.files[0]) {
      var reader = new FileReader();
      canvas = null;
      reader.onload = function(e) {
        image = new Image();
        image.onload = validateImage;
        image.src = e.target.result;
      }
      reader.readAsDataURL(input.files[0]);
    }
  }

  function validateImage() {
    if (canvas != null) {
      image = new Image();
      image.onload = restartJcrop;
      image.src = canvas.toDataURL('image/png');
    } else restartJcrop();
  }

  function restartJcrop() {
    if (jcrop_api != null) {
      jcrop_api.destroy();
    }
    $("#views").empty();
    $("#views").append("<canvas id=\"canvas\">");
    canvas = $("#canvas")[0];
    context = canvas.getContext("2d");
    canvas.width = image.width;
    canvas.height = image.height;
    context.globalCompositeOperation = "source-over";
    context.drawImage(image, 0, 0);
    setHue(); setSaturation(); setLightness();
    $("#canvas").Jcrop({
      onSelect: selectcanvas,
      onRelease: clearcanvas,
      boxWidth: crop_max_width,
      boxHeight: crop_max_height
    }, function() {
      jcrop_api = this;
    });
    clearcanvas();
  }

  function clearcanvas() {
    prefsize = {
      x: 0,
      y: 0,
      w: canvas.width,
      h: canvas.height,
    };
  }

  function selectcanvas(coords) {
    prefsize = {
      x: Math.round(coords.x),
      y: Math.round(coords.y),
      w: Math.round(coords.w),
      h: Math.round(coords.h)
    };
  }

  function applyCrop() {
    canvas.width = prefsize.w;
    canvas.height = prefsize.h;
    context.drawImage(image, prefsize.x, prefsize.y, prefsize.w, prefsize.h, 0, 0, canvas.width, canvas.height);
    validateImage();
  }

  function cropImage() {
    if (image != null)
      applyCrop();
    else
      return;
  };

  function setHue() {
    hue = $('#rHue').val();
    console.log('Hue value = ' + hue); 
    context.globalCompositeOperation = "hue";
    context.fillStyle = `hsl(${hue}, ${sat}%, 50%)`;
    context.fillRect(0, 0, canvas.width, canvas.height);
    resetComposition();
  }

  function setSaturation() {
    sat = $('#rSat').val();
    console.log('Saturation value = ' + sat); 
    context.globalCompositeOperation = "saturation";
    context.fillStyle = `hsl(${hue}, ${sat}%, 50%)`;
    context.fillRect(0, 0, canvas.width, canvas.height);
    resetComposition();
  }

  function setLightness() {
    lightness = $('#rL').val();
    context.globalCompositeOperation = lightness < 100 ? "color-burn" : "color-dodge";
    lightness = (lightness >= 100) ? lightness - 100 : 100 - (100 - lightness);
    console.log('Lightness value = ' + lightness); 
    context.fillStyle = `hsl(${hue}, ${sat}%, ${lightness}%)`;
    context.fillRect(0, 0, canvas.width, canvas.height);
    resetComposition();
  }

  function resetComposition() {
    context.globalCompositeOperation = "destination-in";
    context.drawImage(image, 0, 0, canvas.width, canvas.height);
    context.globalCompositeOperation = "source-over";
  }

  function uploadImage() {
    if (canvas != null) {
      var croppedImage = canvas.toDataURL();
      var outputImage = croppedImage.replace(/^data:image\/(png|jpg);base64,/, "");
      $.ajax({
        url: "/uploadImage",
        type: "POST",
        data: outputImage,
        contentType: false,
        cache: false,
        processData: false,
        success: function(data) {
          console.log('Success: ' + data);
        },
        error: function(data) {
          console.log('Error: ' + data);
        },
        complete: function(data) {}
      });
    }
  }      
</script>